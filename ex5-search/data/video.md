# Видео

Есть несколько способов отображение видео в клиенте:

-   Трансляция из внешних ресурсов (Youtube) через IGB
-   Отображение через Scaleform видео плеер (используется `video_view` на Unbound или `SimpleVideoPlayer` на AS3)
-   Отображение видео через Gameface (тег `<video>`)

## IGB

Выбираем IGB если:

-   Нужна возможность динамического обновления видео в клиенте
-   Есть некий график отображения видео и мы не можем "засветить" его раньше времени

Видео для IGB должны быть кодированы _vp9_ или чем-то подобным, но только **не h.264** или другим проприетарным кодеком.

Минусы использования IGB:

-   В клиенте отображается интерфейс стороннего сервиса (Youtube)
-   Ограничение в 30fps
-   Требуется координация с командами, разворачивающими страницу с видео и заливающими видео на Youtube.

Видео через IGB можно посмотреть в фичах: Полевая почта, BattlePass

## Scaleform

Видео стоит отображать через Scaleform, если:

-   Видео необходимо интегрировать в UX игры (есть пресечения видео и интерфейса, "бесшовные опыт")
-   Необходимо использовать встроенные субтитры
-   Необходимо более чем 30fps
-   То что видео смогут посмотреть сразу после обновления клиента - не проблема

Требования:

-   Формат файла USM
-   Размер файла не более 100MB. При необходимости отображения видео большего размера нужно подключить стриминг
-   Не более 15 дорожек с субтитрами
-   Звук лежит в отдельном файле `bnk` и проигрывать через стандартную звуковую систему (иначе звук из видео не подчиняется звуковым настройкам в игре).

Стоит создавать кастомную вью для отображения видео. Есть стандартная `VideoView` (`video_view.unbound` и `video_view.py`). В ней же интегрирована возможность отображать субтитры, есть кнопка закрыть (можно скрыть), видео останавливается при переводе фокуса с окна.

Фичи, где можно посмотреть отображение видео на Scaleform: LoginPage, BootCamp, NewYear, Marathon, BattlePass.

USM видео можно распаковать утилитой VGM Toolbox ([vgmtoolbox_bin_r1040.7z](../vgmtoolbox_bin_r1040.7z)): Misc. Tools -> Stream Tools -> Video Demultiplexer -> Format: USM

USM видео можно упаковать утилитой VideoEncoder ([VideoEncoder.zip](../VideoEncoder.zip))

## Gameface

### Загрузка видео из локальных источников

Видео-контент из локальных источников загружается через компонент видео-плеера

```js
<video src={путь к файлу}/>
```

Видео-контент в формате `.webm` на данный момент должен храниться по следующему пути:

```
game/res/wot/gui/flash/videos
```

Также, лучшей практикой будет создать по данному пути отдельную папку и поместить туда нужный видео-контент. При необходимости хранить видео в других папках, требуется внести изменения в файл **providers.yaml**, а именно в разделе **all_videos_fs_provider** и подразделе **search_dir** указать нужный путь.

На данный момент в клиент встроен демо-компонент `VideoSupportView.jsx` с примером загрузки и отображения локального видео-контента. `VideoSupportView.jsx` расположен в

```
game\res\wot\gui\gameface\src\development\views\VideoSupportView
```

Стоит отметить, что на проекте так же имеется кастомная обертка для компонентов с видео-контентом, выглядит она следующим образом:

```js
<Video
    src={R.videos.development.example_2()}
    autoPlay
    loop
/>
```

### Управление воспроизведением видео

Для управления загруженным видео предусмотрены следующие параметры:

| Пропс         | Тип       | Описание                                                                                                                                                                                             |
| ------------- | --------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `src`         | `string`  | ссылка на видео-контент (должен быть в формате **.webm**)                                                                                                                                            |
| `autoPlay`    | `boolean` | автоматическое проигрыванием видео сразу после загрузки                                                                                                                                              |
| `crossOrigin` | `string`  | может принимать параметры "`anonymous`" и "`use-credentials`", показывает, что элемент `<video>` поддерживает запрос CORS (используется при получении видеофайлов со сторонних серверов или доменов) |
| `loop`        | `boolean` | зацикливать ли воспроизведение видео                                                                                                                                                                 |
| `preload`     | `string`  | отвечает за параметры загрузки видео, может принимать параметры "`none`", "`metadata`" и "`auto`"                                                                                                    |
| `muted`       | `boolean` | воспроизводить ли звук                                                                                                                                                                               |

Требования специфичные для Gameface:

-   Формат видео WebM
-   видео дорожка одна, закодирована через VP8 или VP9
-   звуковая дорожка одна, закодирована через Vorbis
-   сторонние видео-файлы не подключаются при явном указании порта (например, ссылка `https://dl6.webmfiles.org/big-buck-bunny_trailer.webm` сработает, а `https://dl6.webmfiles.org:443/big-buck-bunny_trailer.webm` - нет ).

## События video

Существуют следующие события **video**:

| Событие         |Описание                                                                                                                                                                                             |
| ------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `durationchange`          | показывает, были ли загружены или изменены метаданные; указывает на изменение продолжительности мультимедиа                                                                                                                                           |
| `emptied`    | медиафайл стал пустым; например, это событие отправляется, если медиафайл уже был загружен (или частично загружен) и для его перезагрузки вызывается метод load()                                                                                                                                              |
| `ended`    | отправляется после завершения воспроизведения                                                                                                                                             |
| `pause` | отправляется, когда видео ставится на паузу (свойство paused равно true) |
| `play`        | отправляется после возврата метода play() или когда атрибут autoplay вызывает изменение состояния воспроизведения. Это не обязательно означает фактическое воспроизведение, поскольку сетевой запрос может быть задержан.                                                                                                                                                         |
| `playing`     | отправляется, когда на медиафайл достаточно загрузился для начала воспроизведения                                                                                                    |
| `seeked`       | отправляется после завершения операции поиска медиафайла         |
| `seeking`        | отправляется во время начала операции поиска медиафайла         |
| `timeupdate`        | отправляется, когда время, указанное атрибутом currentTime элемента, изменилось. Это событие не запускается во время обычного воспроизведения.         |
| `volumechange`  | отправляется при изменении громкости звука (изменение атрибута muted также учитывается)         |
| `error`       | отправляется при ошибке загрузки медиафайла         |
| `cohplaybackstalled`       | отправляется, когда декодер не может поддерживать скорость воспроизведения и не может предоставить новые кадры достаточно быстро. Это событие полезно при попытке синхронизировать воспроизведение видео с другими анимациями, так как декодирование кадров происходит асинхронно и никак не привязано к таймеру просмотра. Обычно достаточно приостановить любую анимацию, которая должна быть синхронизирована с видео, в событии cohplaybackstalled и возобновить ее в событии cohplaybackresumed       |
| `cohplaybackresumed`        | отправляется, когда видео/аудио декодер, который ранее останавливал воспроизведение, теперь "догоняет" и предоставляет новые кадры         |


Также в качетсве атрибутов представлены некоторые обработчики событий:

| Обработчик        |Описание                                                                                                                                                                                             |
| ------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `onClick`          | обработчик нажатия на элемент **video**                                                                                                                                           |
| `onPlay`    | обработчик события **play**                                                                                                                                             |
| `onPause`    | обработчик события **pause**                                                                                                                                                |
| `onLoadedData` | вызывается, когда доступны данные для первого видеокадра |
| `onLoadedMetadata`        | вызывается, как только все метаданные были загружены                                                                                                                                                 |
| `onEnded`     | обработчик события **ended**                                                                                                    |
| `onTimeUpdate`       | ообработчик события **timeupdate**          |
| `onSeeking`        | ообработчик события **seeking**          |

и тд.

## Ссылки

Более подробная информация о поддержке видео (например, как использовать контролы в видео с помощью дополнительной библиотеки):

-   [https://docs.coherent-labs.com/cpp-gameface/integration/optional_features/videosupport/](https://docs.coherent-labs.com/cpp-gameface/integration/optional_features/videosupport/)
